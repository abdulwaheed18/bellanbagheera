<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BNB Yarn Spinner V2 üêæ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #121212;
            user-select: none;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        #exit-zone {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 100;
        }

        .tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.2);
            font-family: sans-serif;
            font-weight: bold;
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: fadeOut 3s forwards 2s;
        }
    </style>
</head>

<body>
    <div class="tutorial">Drag the Yarn</div>
    <div id="exit-zone"></div>
    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { GameEngine, Draw } from './game-utils.js';

        class YarnGame extends GameEngine {
            constructor() {
                super('gameCanvas');

                this.center = { x: this.width / 2, y: this.height / 2 };

                // Spring Physics
                this.ball = {
                    x: this.center.x, y: this.center.y,
                    vx: 0, vy: 0,
                    rk: 0.1, // Rotation speed
                    angle: 0,
                    radius: 50,
                    dragging: false
                };

                this.spring = {
                    k: 0.03, // Spring constant
                    damping: 0.9,
                    len: 0
                };

                this.trail = [];

                this.setupExit();
                this.start((dt) => this.update(dt), (ctx) => this.draw(ctx));
            }

            setupExit() {
                let taps = 0, timer;
                const z = document.getElementById('exit-zone');
                const trig = () => {
                    taps++; clearTimeout(timer);
                    timer = setTimeout(() => taps = 0, 600);
                    if (taps >= 3) window.location.href = 'index.html';
                };
                z.addEventListener('touchstart', (e) => { e.preventDefault(); trig(); });
                z.addEventListener('mousedown', trig);
            }

            update(dt) {
                this.center.x = this.width / 2;
                this.center.y = this.height / 2;

                this.handleInput();
                this.physics(dt);
            }

            handleInput() {
                if (this.input.justPressed) {
                    const dist = Math.hypot(this.input.x - this.ball.x, this.input.y - this.ball.y);
                    if (dist < this.ball.radius + 80) { // Big hit area
                        this.ball.dragging = true;
                    }
                }

                if (!this.input.isDown) {
                    this.ball.dragging = false;
                }
            }

            physics(dt) {
                const b = this.ball;

                if (b.dragging) {
                    // Move towards mouse with slight lag (feels heavy)
                    b.vx = (this.input.x - b.x) * 0.2;
                    b.vy = (this.input.y - b.y) * 0.2;
                    b.x += b.vx;
                    b.y += b.vy;

                    // Rotate based on movement
                    b.angle += (b.vx + b.vy) * 0.01;

                    // Play Purr if moving fast
                    const speed = Math.hypot(b.vx, b.vy);
                    if (speed > 5) this.audio.playTone(100, 'sawtooth', 0.1, 0.05);

                } else {
                    // Spring Force
                    const dx = this.center.x - b.x;
                    const dy = this.center.y - b.y;

                    const ax = dx * this.spring.k;
                    const ay = dy * this.spring.k;

                    b.vx += ax;
                    b.vy += ay;
                    b.vx *= this.spring.damping;
                    b.vy *= this.spring.damping;

                    b.x += b.vx;
                    b.y += b.vy;
                    b.angle += (b.vx + b.vy) * 0.005;
                }
            }

            draw(ctx) {
                ctx.fillStyle = '#121212';
                ctx.fillRect(0, 0, this.width, this.height);

                // Draw String (Curve)
                ctx.beginPath();
                ctx.moveTo(this.center.x, this.center.y);

                // Control point for curve behaves like a slack string
                const midX = (this.center.x + this.ball.x) / 2;
                const midY = (this.center.y + this.ball.y) / 2;
                // Add some "sin wave" slack based on distance
                // Simplified: Quadratic curve to midpoint
                ctx.quadraticCurveTo(midX, midY + (this.ball.x - this.center.x) * 0.2, this.ball.x, this.ball.y);

                ctx.strokeStyle = '#80aaff';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.stroke();

                // Draw Ball
                ctx.save();
                ctx.translate(this.ball.x, this.ball.y);
                ctx.rotate(this.ball.angle);

                // Ball body
                Draw.circle(ctx, 0, 0, this.ball.radius, '#0056b3');

                // Texture (Messy Yarn lines)
                ctx.strokeStyle = '#3385ff';
                ctx.lineWidth = 2;
                for (let i = 0; i < 8; i++) {
                    ctx.beginPath();
                    ctx.moveTo(-40, i * 10 - 35);
                    ctx.lineTo(40, i * 10 - 35);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(i * 10 - 35, -40);
                    ctx.lineTo(i * 10 - 35, 40);
                    ctx.stroke();
                }

                // Gloss
                Draw.circle(ctx, -15, -15, 10, 'rgba(255,255,255,0.1)');

                ctx.restore();

                // Center Peg
                Draw.circle(ctx, this.center.x, this.center.y, 10, '#333');
            }
        }

        new YarnGame();
    </script>
</body>

</html>